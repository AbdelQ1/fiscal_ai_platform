#!/usr/bin/env python3
"""
Test en ligne du module OCR fiscal avec documents fran√ßais r√©els
Test sur : fiches de paie, avis d'imposition, taxe fonci√®re
"""

import sys
import requests
import tempfile
from pathlib import Path
from typing import List, Dict
import time

# Ajout du path parent
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from modules.ocr.base_ocr import FiscalOCRModule
from core.security.encryption import SecurityManager
from data.storage.database import DatabaseManager

class FiscalDocumentTester:
    """Testeur de documents fiscaux fran√ßais avec OCR"""
    
    def __init__(self):
        """Initialisation du testeur avec configuration optimis√©e"""
        self.ocr_config = {
            "languages": ["fra"],  # Fran√ßais uniquement pour plus de pr√©cision
            "confidence_threshold": 0.6,  # Seuil adapt√© aux documents scann√©s
            "preprocessing": ["contrast", "denoise", "deskew"],  # Preprocessing complet
            "fiscal_mode": True
        }
        
        self.ocr_module = FiscalOCRModule(self.ocr_config)
        
        # URLs d'exemples de documents fiscaux fran√ßais (anonymis√©s)
        self.test_documents = {
            "fiche_paie": {
                "url": "https://www.service-public.fr/resources/files/sp_bulletinpaie_exemple.pdf",
                "type": "fiche_paie",
                "entities_attendues": ["montant_euro", "date_fr", "siret"],
                "description": "Exemple fiche de paie Service Public"
            },
            "avis_imposition": {
                "url": "https://www.impots.gouv.fr/sites/default/files/media/1_metier/2_professionnel/EV/2_gestion/280_editer_imprimer/10_modeles_documents/exemples_avis_imposition.pdf",
                "type": "declaration_fiscale",
                "entities_attendues": ["numero_fiscal", "montant_euro", "date_fr"],
                "description": "Exemple avis d'imposition DGFiP"
            }
        }
        
        print("üîç Testeur OCR fiscal initialis√©")
        print(f"   - Configuration: {self.ocr_module.get_module_info()}")

    def download_test_document(self, url: str, doc_type: str) -> Path:
        """T√©l√©charge un document de test depuis une URL"""
        try:
            print(f"üì• T√©l√©chargement: {url}")
            
            response = requests.get(url, timeout=30, allow_redirects=True)
            response.raise_for_status()
            
            # Sauvegarde temporaire
            temp_file = tempfile.NamedTemporaryFile(
                suffix=f'_{doc_type}.pdf', 
                delete=False
            )
            temp_file.write(response.content)
            temp_file.close()
            
            file_path = Path(temp_file.name)
            print(f"‚úÖ T√©l√©charg√©: {file_path} ({len(response.content)} bytes)")
            
            return file_path
            
        except Exception as e:
            print(f"‚ùå Erreur t√©l√©chargement: {e}")
            return None

    def create_local_test_fiche_paie(self) -> Path:
        """Cr√©e une fiche de paie de test locale avec contenu r√©aliste"""
        from PIL import Image, ImageDraw, ImageFont
        
        try:
            # Image haute r√©solution pour OCR optimal
            img = Image.new('RGB', (1200, 1600), color='white')
            draw = ImageDraw.Draw(img)
            
            # Contenu fiche de paie fran√ßaise r√©aliste
            paie_content = [
                "BULLETIN DE PAIE",
                "P√©riode: Janvier 2025",
                "",
                "ENTREPRISE MARTIN SARL",
                "SIRET: 12345678901234",
                "NAF: 7022Z",
                "",
                "SALARI√â: DUPONT Jean",
                "N¬∞ S√©curit√© Sociale: 1 85 01 75 116 234 56",
                "",
                "√âL√âMENTS DE R√âMUN√âRATION",
                "",
                "Salaire de base           2.500,00‚Ç¨",
                "Heures suppl√©mentaires     125,50‚Ç¨", 
                "Prime anciennet√©           150,00‚Ç¨",
                "",
                "BRUT                     2.775,50‚Ç¨",
                "",
                "COTISATIONS SALARIALES",
                "S√©curit√© sociale           215,44‚Ç¨",
                "Retraite compl√©mentaire     83,27‚Ç¨",
                "Ch√¥mage                     69,39‚Ç¨",
                "CSG                        181,91‚Ç¨",
                "",
                "TOTAL COTISATIONS          549,01‚Ç¨",
                "",
                "NET √Ä PAYER              2.226,49‚Ç¨",
                "",
                "Date de paiement: 31/01/2025",
                "√âtabli le: 30/01/2025"
            ]
            
            # Dessin avec mise en forme professionnelle
            y_offset = 50
            line_height = 35
            
            for line in paie_content:
                if "BULLETIN DE PAIE" in line:
                    # Titre en gras (simul√© avec r√©p√©tition)
                    draw.text((300, y_offset), line, fill='black')
                    draw.text((301, y_offset), line, fill='black')  # Effet gras
                elif line.startswith("√âL√âMENTS") or line.startswith("COTISATIONS") or "BRUT" in line or "NET √Ä PAYER" in line:
                    # Sections importantes
                    draw.text((100, y_offset), line, fill='black')
                    draw.text((101, y_offset), line, fill='black')  # Effet gras
                elif line.strip():
                    # Contenu normal
                    draw.text((150, y_offset), line, fill='black')
                
                y_offset += line_height
            
            # Sauvegarde
            temp_file = tempfile.NamedTemporaryFile(suffix='_fiche_paie_test.png', delete=False)
            img.save(temp_file.name, 'PNG', quality=95, dpi=(300, 300))
            
            return Path(temp_file.name)
            
        except Exception as e:
            print(f"‚ùå Erreur cr√©ation fiche de paie test: {e}")
            return None

    def create_local_test_avis_imposition(self) -> Path:
        """Cr√©e un avis d'imposition de test local"""
        from PIL import Image, ImageDraw
        
        try:
            img = Image.new('RGB', (1200, 1600), color='white')
            draw = ImageDraw.Draw(img)
            
            # Contenu avis d'imposition fran√ßais
            imposition_content = [
                "AVIS D'IMPOSITION SUR LE REVENU",
                "Ann√©e 2024 - Revenus 2023",
                "",
                "N¬∞ FISCAL: 2345678901234",
                "N¬∞ T√âL√âD√âCLARANT: 9876543210",
                "",
                "CONTRIBUABLE: MARTIN Pierre",
                "ADRESSE: 123 Rue de la R√©publique",
                "75001 PARIS",
                "",
                "SITUATION DE FAMILLE",
                "C√©libataire - 0 personne √† charge",
                "",
                "REVENUS D√âCLAR√âS",
                "",
                "Traitements et salaires      45.230,00‚Ç¨",
                "Revenus fonciers              3.200,00‚Ç¨",
                "Plus-values                     850,00‚Ç¨",
                "",
                "REVENU BRUT GLOBAL           49.280,00‚Ç¨",
                "Charges d√©ductibles           2.100,00‚Ç¨",
                "REVENU NET GLOBAL            47.180,00‚Ç¨",
                "",
                "CALCUL DE L'IMP√îT",
                "",
                "Revenu net imposable         47.180,00‚Ç¨",
                "Nombre de parts: 1",
                "Quotient familial            47.180,00‚Ç¨",
                "",
                "Imp√¥t brut                    8.435,00‚Ç¨",
                "D√©cote                            0,00‚Ç¨",
                "Cr√©dit d'imp√¥t                  325,00‚Ç¨",
                "",
                "IMP√îT NET D√õ                  8.110,00‚Ç¨",
                "",
                "Date limite de paiement: 15/09/2024",
                "√âtabli le: 25/07/2024"
            ]
            
            # Dessin
            y_offset = 40
            line_height = 32
            
            for line in imposition_content:
                if "AVIS D'IMPOSITION" in line:
                    draw.text((250, y_offset), line, fill='black')
                    draw.text((251, y_offset), line, fill='black')
                elif any(keyword in line for keyword in ["REVENUS", "CALCUL", "SITUATION"]):
                    draw.text((100, y_offset), line, fill='black')
                    draw.text((101, y_offset), line, fill='black')
                elif line.strip():
                    draw.text((150, y_offset), line, fill='black')
                
                y_offset += line_height
            
            # Sauvegarde
            temp_file = tempfile.NamedTemporaryFile(suffix='_avis_imposition_test.png', delete=False)
            img.save(temp_file.name, 'PNG', quality=95, dpi=(300, 300))
            
            return Path(temp_file.name)
            
        except Exception as e:
            print(f"‚ùå Erreur cr√©ation avis imposition test: {e}")
            return None

    def create_local_test_taxe_fonciere(self) -> Path:
        """Cr√©e un avis de taxe fonci√®re de test local"""
        from PIL import Image, ImageDraw
        
        try:
            img = Image.new('RGB', (1200, 1400), color='white')
            draw = ImageDraw.Draw(img)
            
            # Contenu taxe fonci√®re fran√ßais
            taxe_content = [
                "AVIS DE TAXE FONCI√àRE",
                "Ann√©e 2024",
                "",
                "COMMUNE: PARIS 15√®me",
                "N¬∞ COMPTE COMMUNAL: 075115123456789",
                "",
                "PROPRI√âTAIRE: DUPONT Marie",
                "ADRESSE: 45 Avenue de la Libert√©",
                "75015 PARIS",
                "",
                "D√âSIGNATION DU BIEN",
                "",
                "Adresse: 12 Rue Victor Hugo",
                "75015 PARIS",
                "Lot: 456 - Section: AB",
                "Parcelle: 123",
                "",
                "VALEUR LOCATIVE CADASTRALE",
                "",
                "Valeur locative brute         4.200,00‚Ç¨",
                "Abattements                     420,00‚Ç¨",
                "Valeur locative nette         3.780,00‚Ç¨",
                "",
                "CALCUL DE LA TAXE",
                "",
                "Taxe communale 35,15%        1.328,67‚Ç¨",
                "Taxe d√©partementale 15,80%     597,24‚Ç¨",
                "Taxe r√©gionale 3,60%           136,08‚Ç¨",
                "",
                "TOTAL TAXE FONCI√àRE          2.061,99‚Ç¨",
                "",
                "√âch√©ance 1 (50%): 15/10/2024  1.030,99‚Ç¨",
                "√âch√©ance 2 (50%): 15/12/2024  1.030,99‚Ç¨",
                "",
                "Date d'√©mission: 15/09/2024"
            ]
            
            # Dessin
            y_offset = 50
            line_height = 32
            
            for line in taxe_content:
                if "AVIS DE TAXE" in line:
                    draw.text((300, y_offset), line, fill='black')
                    draw.text((301, y_offset), line, fill='black')
                elif any(keyword in line for keyword in ["D√âSIGNATION", "VALEUR", "CALCUL"]):
                    draw.text((100, y_offset), line, fill='black')
                    draw.text((101, y_offset), line, fill='black')
                elif line.strip():
                    draw.text((150, y_offset), line, fill='black')
                
                y_offset += line_height
            
            # Sauvegarde
            temp_file = tempfile.NamedTemporaryFile(suffix='_taxe_fonciere_test.png', delete=False)
            img.save(temp_file.name, 'PNG', quality=95, dpi=(300, 300))
            
            return Path(temp_file.name)
            
        except Exception as e:
            print(f"‚ùå Erreur cr√©ation taxe fonci√®re test: {e}")
            return None

    def test_document_ocr(self, document_path: Path, doc_type: str, description: str) -> Dict:
        """Test OCR sur un document avec analyse d√©taill√©e"""
        print(f"\nüîç Test OCR: {description}")
        print(f"   üìÑ Fichier: {document_path.name}")
        
        try:
            start_time = time.time()
            
            # Traitement OCR
            result = self.ocr_module.process_document(document_path, doc_type)
            
            # Analyse des r√©sultats
            analysis = {
                "success": result.success,
                "confidence": result.confidence,
                "processing_time": result.processing_time,
                "word_count": result.word_count,
                "text_length": len(result.text),
                "entities_found": result.extracted_entities or {},
                "preprocessing": result.preprocessing_applied,
                "document_type": doc_type,
                "description": description
            }
            
            # Affichage des r√©sultats
            if result.success:
                print(f"   ‚úÖ OCR r√©ussi")
                print(f"   üìä Confiance: {result.confidence:.2f}")
                print(f"   ‚è±Ô∏è  Temps: {result.processing_time:.2f}s")
                print(f"   üìù Mots extraits: {result.word_count}")
                print(f"   üîß Pr√©processing: {', '.join(result.preprocessing_applied)}")
                
                # Affichage texte extrait (aper√ßu)
                if result.text:
                    preview = result.text[:200].replace('\n', ' ')
                    print(f"   üìñ Aper√ßu texte: {preview}...")
                
                # Analyse des entit√©s fiscales
                if result.extracted_entities:
                    print(f"   üè∑Ô∏è  Entit√©s fiscales trouv√©es:")
                    for entity_type, values in result.extracted_entities.items():
                        print(f"      - {entity_type}: {values}")
                else:
                    print(f"   üè∑Ô∏è  Aucune entit√© fiscale d√©tect√©e")
                
            else:
                print(f"   ‚ùå OCR √©chou√©: {result.error_message}")
            
            return analysis
            
        except Exception as e:
            print(f"   ‚ùå Erreur test: {e}")
            return {
                "success": False,
                "error": str(e),
                "document_type": doc_type,
                "description": description
            }

    def run_comprehensive_test(self):
        """Lance un test complet sur tous les types de documents"""
        print("üöÄ D√âMARRAGE TEST COMPLET OCR DOCUMENTS FISCAUX FRAN√áAIS")
        print("=" * 70)
        
        results = []
        temp_files = []
        
        try:
            # Test 1: Fiche de paie locale
            print("\nüìë TEST 1: FICHE DE PAIE")
            fiche_paie_path = self.create_local_test_fiche_paie()
            if fiche_paie_path:
                temp_files.append(fiche_paie_path)
                result = self.test_document_ocr(
                    fiche_paie_path, 
                    "fiche_paie", 
                    "Fiche de paie fran√ßaise simul√©e"
                )
                results.append(result)
            
            # Test 2: Avis d'imposition local
            print("\nüìë TEST 2: AVIS D'IMPOSITION")
            avis_path = self.create_local_test_avis_imposition()
            if avis_path:
                temp_files.append(avis_path)
                result = self.test_document_ocr(
                    avis_path, 
                    "declaration_fiscale", 
                    "Avis d'imposition fran√ßais simul√©"
                )
                results.append(result)
            
            # Test 3: Taxe fonci√®re locale
            print("\nüìë TEST 3: TAXE FONCI√àRE")
            taxe_path = self.create_local_test_taxe_fonciere()
            if taxe_path:
                temp_files.append(taxe_path)
                result = self.test_document_ocr(
                    taxe_path, 
                    "taxe_fonciere", 
                    "Avis de taxe fonci√®re fran√ßais simul√©"
                )
                results.append(result)
            
            # Synth√®se des r√©sultats
            self.display_test_summary(results)
            
        finally:
            # Nettoyage des fichiers temporaires
            print("\nüßπ Nettoyage des fichiers temporaires...")
            for temp_file in temp_files:
                try:
                    temp_file.unlink(missing_ok=True)
                    print(f"   ‚úÖ Supprim√©: {temp_file.name}")
                except Exception as e:
                    print(f"   ‚ö†Ô∏è Erreur suppression {temp_file.name}: {e}")

    def display_test_summary(self, results: List[Dict]):
        """Affiche un r√©sum√© d√©taill√© des tests"""
        print("\n" + "=" * 70)
        print("üìä SYNTH√àSE DES TESTS OCR DOCUMENTS FISCAUX")
        print("=" * 70)
        
        successful_tests = [r for r in results if r.get('success', False)]
        failed_tests = [r for r in results if not r.get('success', False)]
        
        print(f"‚úÖ Tests r√©ussis: {len(successful_tests)}/{len(results)}")
        print(f"‚ùå Tests √©chou√©s: {len(failed_tests)}/{len(results)}")
        
        if successful_tests:
            avg_confidence = sum(r['confidence'] for r in successful_tests) / len(successful_tests)
            avg_time = sum(r['processing_time'] for r in successful_tests) / len(successful_tests)
            total_words = sum(r['word_count'] for r in successful_tests)
            
            print(f"\nüìà STATISTIQUES:")
            print(f"   - Confiance moyenne: {avg_confidence:.2f}")
            print(f"   - Temps moyen: {avg_time:.2f}s")
            print(f"   - Total mots extraits: {total_words}")
            
            print(f"\nüè∑Ô∏è ENTIT√âS FISCALES D√âTECT√âES:")
            all_entities = {}
            for result in successful_tests:
                for entity_type, values in result.get('entities_found', {}).items():
                    if entity_type not in all_entities:
                        all_entities[entity_type] = 0
                    all_entities[entity_type] += len(values)
            
            for entity_type, count in all_entities.items():
                print(f"   - {entity_type}: {count} occurrence(s)")
        
        if failed_tests:
            print(f"\n‚ö†Ô∏è √âCHECS:")
            for failed in failed_tests:
                print(f"   - {failed['description']}: {failed.get('error', 'Confiance insuffisante')}")
        
        # Recommandations
        print(f"\nüí° RECOMMANDATIONS:")
        if len(successful_tests) == len(results):
            print("   ‚úÖ Module OCR parfaitement op√©rationnel pour documents fiscaux fran√ßais")
            print("   ‚úÖ Pr√™t pour int√©gration en production")
        elif len(successful_tests) > 0:
            print("   ‚ö†Ô∏è Module OCR partiellement fonctionnel")
            print("   üí° Consid√©rer ajustement seuils de confiance ou pr√©processing")
        else:
            print("   ‚ùå Module OCR n√©cessite optimisation")
            print("   üí° V√©rifier configuration Tesseract et qualit√© images")

def main():
    """Point d'entr√©e principal du test"""
    try:
        tester = FiscalDocumentTester()
        tester.run_comprehensive_test()
        
        print("\nüéâ TEST COMPLET TERMIN√â")
        print("Votre module OCR fiscal est maintenant test√© sur documents fran√ßais r√©alistes !")
        
    except Exception as e:
        print(f"‚ùå Erreur critique du test: {e}")
        return False
    
    return True

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)

